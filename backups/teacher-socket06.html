<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Teacher AI Client (Local LLM Responder)</title>
    <style>
        /* Minimal CSS for Simplicity */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f3f4f6; }
        #myContainer { width: 95%; max-width: 800px; margin: 0 auto; padding-top: 10px; padding-bottom: 90px; }
        h1 { font-size: 24px; text-align: center; color: #4f46e5; }
        .status-text { text-align: center; margin-bottom: 15px; font-weight: 500; }
        .my-controls { 
            display: flex; flex-direction: column; gap: 10px; padding: 15px; margin-bottom: 20px; 
            background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .my-controls textarea { height: 70px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        #myConnectButton { 
            background-color: #10b981; color: white; font-weight: 600; border: none; 
            padding: 10px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; 
        }
        #myConnectButton:disabled { opacity: 0.5; cursor: not-allowed; }
        #myChatLog { 
            background-color: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; 
            height: calc(100vh - 300px); overflow-y: auto; scroll-behavior: smooth; 
        }

        /* Status Colors */
        .status-green { color: #10b981; }
        .status-red { color: #ef4444; }
        .status-yellow { color: #f59e0b; }
        .status-blue { color: #3b82f6; } /* New color for timing */

        /* Message Bubbles */
        .my-message-bubble { margin-bottom: 12px; max-width: 90%; }
        .message-content { padding: 10px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .my-message-other .message-content { background-color: #e5e7eb; color: #1f2937; } 
        .my-message-ai .message-content { background-color: #bae6fd; color: #0369a1; font-weight: 600; border: 2px solid #38bdf8; } /* Special AI bubble */
        .my-message-system { text-align: center; font-size: 12px; margin-bottom: 12px; font-weight: 500; color: #6b7280; }
        .message-time { font-size: 10px; opacity: 0.7; margin-top: 4px; display: block; }
    </style>
</head>
<body>
    <div id="myContainer">
        <h1>Teacher AI Client (Local Network LLM)</h1>
        <p id="myWSStatus" class="status-text status-red">
            WS Status: Disconnected. Select address and connect.
        </p>
        <p id="myAIStatus" class="status-text status-red">
            AI Status: Loading LanguageModel...
        </p>
        <p id="myTimerStatus" class="status-text status-blue" style="margin-top: -10px; display: none;">
            LLM Response Time: 0.0s
        </p>
        
        <div class="my-controls">
            <label for="myServerSelect" style="font-weight: 600; font-size: 14px;">Server Address:</label>
            <select id="myServerSelect" onchange="myHandleSelectChange()">
                <option value="" disabled selected>--- Select Server Option ---</option>
                <option value="ws://localhost:8080">1. Localhost: ws://localhost:8080</option>
                <option value="custom">2. Enter Custom Address Below</option>
            </select>
            <input type="text" id="myCustomInput" placeholder="Enter custom ws://address:port" style="display: none;" onchange="myHandleCustomInputChange()"/>
            <button id="myConnectButton" onclick="myInitWebSocket()" disabled>Connect & Start AI</button>
            <div style="border-top: 1px solid #ddd; margin-top: 10px; padding-top: 10px;">
                <h2 style="font-size: 16px; margin-top: 0; color: #4CAF50;">Current Prompt:</h2>
                <textarea id="myCurrentPrompt" placeholder="Incoming student messages will appear here..." readonly></textarea>
            </div>
        </div>
        <div id="myChatLog"></div>
    </div>
    <script>
        // --- My Core Variables ---
        let myWebSocket = null;
        let myServerUrl = ''; 
        let myLanguageModelSession = null;
        let myIsProcessing = false; // Flag to prevent processing multiple prompts simultaneously
        let myTimerInterval = null; // New timer variable
        let myStartTime = 0;        // New start time variable
                
        const myChatLog = document.getElementById('myChatLog');
        const myWSStatus = document.getElementById('myWSStatus');
        const myAIStatus = document.getElementById('myAIStatus');
        const myTimerStatus = document.getElementById('myTimerStatus'); // New status element
        const myServerSelect = document.getElementById('myServerSelect');
        const myCustomInput = document.getElementById('myCustomInput');
        const myConnectButton = document.getElementById('myConnectButton');
        const myCurrentPrompt = document.getElementById('myCurrentPrompt');

        // --- Timer Functions ---

        function myStartTimer() {
            myStartTime = Date.now();
            myTimerStatus.style.display = 'block';
            myTimerStatus.textContent = "LLM Response Time: 0.0s";
            
            if (myTimerInterval) {
                clearInterval(myTimerInterval);
            }
            
            // Update the timer every 100 milliseconds
            myTimerInterval = setInterval(() => {
                const myElapsedTime = (Date.now() - myStartTime) / 1000;
                myTimerStatus.textContent = `LLM Response Time: ${myElapsedTime.toFixed(1)}s`;
            }, 100);
        }

        function myStopTimer() {
            if (myTimerInterval) {
                clearInterval(myTimerInterval);
                myTimerInterval = null;
            }
            const myTotalTime = (Date.now() - myStartTime) / 1000;
            myTimerStatus.textContent = `LLM Response Time: ${myTotalTime.toFixed(1)}s`;
            // Keep the time displayed until the next request
        }

        // --- UI & Connection Logic ---
        
        function myHandleSelectChange() {
            const mySelectedValue = myServerSelect.value;
            if (mySelectedValue === 'custom') {
                myCustomInput.style.display = 'block';
                myServerUrl = myCustomInput.value.trim();
                myConnectButton.disabled = !myServerUrl;
            } else if (mySelectedValue) {
                myCustomInput.style.display = 'none';
                myServerUrl = mySelectedValue;
                myConnectButton.disabled = false;
            } else {
                myCustomInput.style.display = 'none';
                myServerUrl = '';
                myConnectButton.disabled = true;
            }
        }

        function myHandleCustomInputChange() {
            myServerUrl = myCustomInput.value.trim();
            myConnectButton.disabled = !myServerUrl;
        }

        // 1. Initialize WebSocket Connection
        async function myInitWebSocket() {
            if (!myServerUrl) {
                myDisplaySystemMessage("Please select a server address.", 'error');
                return;
            }
                        
            myWSStatus.textContent = "WS Status: Connecting...";
            myWSStatus.classList.remove('status-green', 'status-red');
            myWSStatus.classList.add('status-yellow');
            myConnectButton.disabled = true;

            try {
                // First, ensure the AI session is ready
                await myInitAISession();
                if (!myLanguageModelSession) {
                    myWSStatus.textContent = "WS Status: Cannot connect, AI failed to load.";
                    myConnectButton.disabled = false;
                    return;
                }

                // Close any existing connection
                if (myWebSocket && myWebSocket.readyState !== WebSocket.CLOSED) {
                    myWebSocket.close(1000, 'Reconnecting');
                }
                                
                myWebSocket = new WebSocket(myServerUrl);

                myWebSocket.onopen = async () => {
                    myWSStatus.textContent = "WS Status: Connected and ready!";
                    myWSStatus.classList.remove('status-red', 'status-yellow');
                    myWSStatus.classList.add('status-green');
                    myConnectButton.disabled = false;
                    myDisplaySystemMessage("Connected to Node.js server.", 'system');
                };

                // 2. Handle incoming messages (Student Prompts)
                myWebSocket.onmessage = async (myEvent) => {
                    const myText = myEvent.data;
                    myDisplayMessage(myText, 'other'); // Display student message locally
                                        
                    // Trigger the AI processing chain
                    await myProcessStudentPrompt(myText);
                };

                myWebSocket.onerror = async (myError) => {
                    console.error("WebSocket Error:", myError);
                    myWSStatus.textContent = "WS Status: Connection error.";
                    myWSStatus.classList.add('status-red');
                };

                myWebSocket.onclose = async (myEvent) => {
                    myWSStatus.textContent = `WS Status: Disconnected (Code: ${myEvent.code}).`;
                    myWSStatus.classList.remove('status-yellow');
                    myWSStatus.classList.add('status-red');
                    myConnectButton.disabled = false;
                };
            } catch (myError) {
                myWSStatus.textContent = "WS Status: Failed to initialize. Check console.";
                myConnectButton.disabled = false;
            }
        }

        // --- Chrome AI Logic ---

        // Initializes the Chrome AI LanguageModel session
        async function myInitAISession() {
            if (!('LanguageModel' in window)) {
                myAIStatus.textContent = "AI Status: LanguageModel API not found! Check Chrome flags.";
                myAIStatus.classList.add('status-red');
                return false;
            }

            try {
                myAIStatus.textContent = 'AI Status: Creating LanguageModel session...';
                myLanguageModelSession = await LanguageModel.create();
                myAIStatus.textContent = 'AI Status: Ready to generate responses.';
                myAIStatus.classList.remove('status-red', 'status-yellow');
                myAIStatus.classList.add('status-green');
                return true;
            } catch (myError) {
                myAIStatus.textContent = 'AI Status: Error creating AI session.';
                myAIStatus.classList.remove('status-yellow');
                myAIStatus.classList.add('status-red');
                console.error("AI Session Error:", myError);
                return false;
            }
        }

        // Processes the incoming chat message using the AI
        async function myProcessStudentPrompt(myPromptValue) {

    // --- NEW CHECK START ---
    if (!myPromptValue.includes('[LLM]')) {
        // If the prompt does NOT contain [LLM], we skip the AI process
        myDisplaySystemMessage("Message received but does not contain [LLM]. Skipping AI prompt.", 'system');
        myCurrentPrompt.value = myPromptValue; // Still show the message
        myIsProcessing = false; // Ensure the processing flag is false since we didn't process
        return; // EXIT the function early
    }
    // --- NEW CHECK END ---
            if (myIsProcessing) {
                myDisplaySystemMessage("AI is busy! Skipping new prompt.", 'error');
                return;
            }
                        
            myIsProcessing = true;
            myCurrentPrompt.value = myPromptValue;
            myAIStatus.textContent = 'AI Status: PROCESSING PROMPT...';
            myAIStatus.classList.remove('status-green');
            myAIStatus.classList.add('status-yellow');

            myDisplaySystemMessage("AI is generating response...", 'system');
            
            try {
                if (!myLanguageModelSession) { 
                    throw new Error("AI Session not initialized.");
                }

                // --- Timer Start ---
                myStartTimer();

                // 1. Send prompt to Chrome AI
                const myAIResponseText = await myLanguageModelSession.prompt(myPromptValue);
                
                // --- Timer Stop ---
                myStopTimer();
                                
                // 2. Display AI Response locally
                myDisplayMessage(myAIResponseText, 'ai'); 

                // 3. Send AI Response back to Node.js server for broadcast
                if (myWebSocket && myWebSocket.readyState === WebSocket.OPEN) {
                    myWebSocket.send(myAIResponseText); 
                } else {
                    myDisplaySystemMessage("AI response generated, but WS is closed. Cannot send.", 'error');
                }

                myAIStatus.textContent = "AI Status: Response sent. Waiting for next chat prompt.";
                myAIStatus.classList.remove('status-yellow');
                myAIStatus.classList.add('status-green');

            } catch (myError) {
                myStopTimer();
                myAIStatus.textContent = "AI Status: Error during prompt execution. See console.";
                myAIStatus.classList.remove('status-yellow');
                myAIStatus.classList.add('status-red');
                myDisplaySystemMessage("AI FAILED to respond. Check your Chrome flags.", 'error');
                console.error("AI Execution Error:", myError);
            } finally {
                myIsProcessing = false;
            }
        }
                
        // --- Message Display Functions ---

        function myDisplayMessage(myText, myType) {
            const myNewMessageDiv = document.createElement('div');
            // 'other' for student messages, 'ai' for AI generated responses
            const myClass = (myType === 'ai') ? 'my-message-ai' : 'my-message-other'; 
            myNewMessageDiv.classList.add('my-message-bubble', myClass);

            const myTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            myNewMessageDiv.innerHTML = `
                <div class="message-content">
                    <span class="block">${myText}</span>
                    <span class="message-time">${myTime}</span>
                </div>
            `;
            myChatLog.appendChild(myNewMessageDiv);
            myChatLog.scrollTop = myChatLog.scrollHeight;
        }

        function myDisplaySystemMessage(myText, myType) {
            const mySystemDiv = document.createElement('div');
            mySystemDiv.classList.add('my-message-system', myType);
            mySystemDiv.textContent = `--- ${myText} ---`;
            myChatLog.appendChild(mySystemDiv);
            myChatLog.scrollTop = myChatLog.scrollHeight;
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => { 
            myHandleSelectChange();
        });
    </script>
</body>
</html>
